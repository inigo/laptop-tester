<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laptop Hardware Test - Webcam & Microphone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        #video {
            width: 100%;
            border-radius: 10px;
            background: #000;
            display: none;
        }

        #message {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 16px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .button {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        .button:hover {
            background: #5568d3;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .controls {
            text-align: center;
            margin-top: 20px;
        }

        .container + .container {
            margin-top: 30px;
        }

        #audioCanvas {
            width: 100%;
            height: 150px;
            border-radius: 10px;
            background: #f5f5f5;
            display: none;
        }

        #audioMessage, #speakerMessage {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 16px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .timer {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-top: 15px;
        }

        .trackpad-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .trackpad-button {
            flex: 1;
            max-width: 300px;
            height: 200px;
            border-radius: 20px;
            background: #f5f5f5;
            border: 3px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
        }

        .trackpad-button.active {
            background: #667eea;
            border-color: #5568d3;
            color: white;
            transform: scale(0.98);
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .trackpad-info {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            font-size: 16px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-top: 20px;
        }

        .keyboard-container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            overflow-x: auto;
        }

        .keyboard-row {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
            justify-content: center;
        }

        .key {
            background: white;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: #333;
            cursor: default;
            user-select: none;
            transition: all 0.1s ease;
            text-align: center;
        }

        .key.active {
            background: #667eea;
            color: white;
            transform: scale(0.95);
        }

        .key.pressed {
            border-color: #4ade80;
            border-width: 3px;
        }

        .key.inactive {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .key-1-5 { min-width: 60px; }
        .key-1-75 { min-width: 70px; }
        .key-2 { min-width: 80px; }
        .key-2-25 { min-width: 90px; }
        .key-2-5 { min-width: 100px; }
        .key-6 { min-width: 240px; }
        .key-nav { min-width: 50px; }

        #keyboardMessage {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            font-size: 16px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .button {
                padding: 10px 24px;
                font-size: 14px;
            }

            .trackpad-buttons {
                flex-direction: column;
                gap: 15px;
            }

            .trackpad-button {
                max-width: 100%;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Webcam Test Tool</h1>
        <p class="subtitle">Test if your laptop's webcam is working properly</p>

        <video id="video" autoplay playsinline></video>
        <div id="message">Click the button below to start the webcam test</div>

        <div class="controls">
            <button id="startBtn" class="button">Start Webcam Test</button>
            <button id="stopBtn" class="button" style="display: none;">Stop Webcam</button>
        </div>

        <div id="status"></div>
    </div>

    <div class="container">
        <h1>Microphone Test Tool</h1>
        <p class="subtitle">Test if your laptop's microphone is working properly</p>

        <canvas id="audioCanvas"></canvas>
        <div id="audioMessage">Click the button below to start the microphone test</div>
        <div id="timer" class="timer" style="display: none;"></div>

        <div class="controls">
            <button id="startAudioBtn" class="button">Start Microphone Test</button>
            <button id="stopAudioBtn" class="button" style="display: none;">Stop Recording</button>
            <button id="playbackBtn" class="button" style="display: none;">Play Recording</button>
        </div>

        <div id="audioStatus"></div>
    </div>

    <div class="container">
        <h1>Speaker Test Tool</h1>
        <p class="subtitle">Test if your laptop's speakers are working properly</p>

        <div id="speakerMessage">Click the button below to start the speaker test</div>
        <div id="speakerIndicator" class="trackpad-info" style="display: none;">
            <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="speakerPhase">Center</div>
            <div style="margin-top: 10px; color: #666;">Listen for the tone</div>
        </div>

        <div class="controls">
            <button id="startSpeakerBtn" class="button">Start Speaker Test</button>
            <button id="stopSpeakerBtn" class="button" style="display: none;">Stop Test</button>
        </div>

        <div id="speakerStatus"></div>
    </div>

    <div class="container">
        <h1>Trackpad Button Test Tool</h1>
        <p class="subtitle">Test if your laptop's trackpad buttons are working properly</p>

        <div class="trackpad-buttons">
            <div class="trackpad-button" id="leftButton">
                Left Button
            </div>
            <div class="trackpad-button" id="rightButton">
                Right Button
            </div>
        </div>

        <div class="trackpad-info">
            Click the left and right mouse buttons to test. The corresponding button above will highlight when clicked.
        </div>

        <div id="trackpadStatus"></div>
    </div>

    <div class="container">
        <h1>Keyboard Test Tool</h1>
        <p class="subtitle">Test if your laptop's keyboard keys are working properly</p>

        <div id="keyboardMessage">Click the button below to start the keyboard test</div>

        <div class="keyboard-container" id="keyboardContainer" style="display: none;">
            <!-- Function Row -->
            <div class="keyboard-row">
                <div class="key" data-key="Escape">Esc</div>
                <div class="key" data-key="F1">F1</div>
                <div class="key" data-key="F2">F2</div>
                <div class="key" data-key="F3">F3</div>
                <div class="key" data-key="F4">F4</div>
                <div class="key" data-key="F5">F5</div>
                <div class="key" data-key="F6">F6</div>
                <div class="key" data-key="F7">F7</div>
                <div class="key" data-key="F8">F8</div>
                <div class="key" data-key="F9">F9</div>
                <div class="key" data-key="F10">F10</div>
                <div class="key" data-key="F11">F11</div>
                <div class="key" data-key="F12">F12</div>
            </div>

            <!-- Number Row -->
            <div class="keyboard-row">
                <div class="key" data-key="`">` ¬</div>
                <div class="key" data-key="1">1 !</div>
                <div class="key" data-key="2">2 "</div>
                <div class="key" data-key="3">3 £</div>
                <div class="key" data-key="4">4 $</div>
                <div class="key" data-key="5">5 %</div>
                <div class="key" data-key="6">6 ^</div>
                <div class="key" data-key="7">7 &</div>
                <div class="key" data-key="8">8 *</div>
                <div class="key" data-key="9">9 (</div>
                <div class="key" data-key="0">0 )</div>
                <div class="key" data-key="-">- _</div>
                <div class="key" data-key="=">=  +</div>
                <div class="key key-2" data-key="Backspace">Backspace</div>
            </div>

            <!-- QWERTY Row -->
            <div class="keyboard-row">
                <div class="key key-1-5" data-key="Tab">Tab</div>
                <div class="key" data-key="q">Q</div>
                <div class="key" data-key="w">W</div>
                <div class="key" data-key="e">E</div>
                <div class="key" data-key="r">R</div>
                <div class="key" data-key="t">T</div>
                <div class="key" data-key="y">Y</div>
                <div class="key" data-key="u">U</div>
                <div class="key" data-key="i">I</div>
                <div class="key" data-key="o">O</div>
                <div class="key" data-key="p">P</div>
                <div class="key" data-key="[">[  {</div>
                <div class="key" data-key="]">]  }</div>
                <div class="key key-1-5" data-key="Enter">Enter</div>
            </div>

            <!-- ASDF Row -->
            <div class="keyboard-row">
                <div class="key key-1-75" data-key="CapsLock">Caps</div>
                <div class="key" data-key="a">A</div>
                <div class="key" data-key="s">S</div>
                <div class="key" data-key="d">D</div>
                <div class="key" data-key="f">F</div>
                <div class="key" data-key="g">G</div>
                <div class="key" data-key="h">H</div>
                <div class="key" data-key="j">J</div>
                <div class="key" data-key="k">K</div>
                <div class="key" data-key="l">L</div>
                <div class="key" data-key=";">; :</div>
                <div class="key" data-key="'">' @</div>
                <div class="key" data-key="#"># ~</div>
            </div>

            <!-- ZXCV Row -->
            <div class="keyboard-row">
                <div class="key key-2-25" data-key="ShiftLeft">Shift</div>
                <div class="key" data-key="\">\ |</div>
                <div class="key" data-key="z">Z</div>
                <div class="key" data-key="x">X</div>
                <div class="key" data-key="c">C</div>
                <div class="key" data-key="v">V</div>
                <div class="key" data-key="b">B</div>
                <div class="key" data-key="n">N</div>
                <div class="key" data-key="m">M</div>
                <div class="key" data-key=",">, &lt;</div>
                <div class="key" data-key=".">. &gt;</div>
                <div class="key" data-key="/">/ ?</div>
                <div class="key key-2-25" data-key="ShiftRight">Shift</div>
            </div>

            <!-- Bottom Row -->
            <div class="keyboard-row">
                <div class="key key-1-5" data-key="ControlLeft">Ctrl</div>
                <div class="key key-1-5" data-key="MetaLeft">Win</div>
                <div class="key key-1-5" data-key="AltLeft">Alt</div>
                <div class="key key-6" data-key=" ">Space</div>
                <div class="key key-1-5" data-key="AltRight">Alt Gr</div>
                <div class="key key-1-5" data-key="MetaRight">Win</div>
                <div class="key key-1-5" data-key="ContextMenu">Menu</div>
                <div class="key key-1-5" data-key="ControlRight">Ctrl</div>
            </div>

            <!-- Bottom section: Arrow Keys and Navigation Cluster -->
            <div style="display: flex; gap: 60px; justify-content: center; margin-top: 10px;">
                <!-- Arrow Keys (Left) -->
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div class="keyboard-row" style="justify-content: flex-start; margin-bottom: 0;">
                        <div style="min-width: 40px;"></div>
                        <div class="key" data-key="ArrowUp">↑</div>
                    </div>
                    <div class="keyboard-row" style="justify-content: flex-start; margin-bottom: 0;">
                        <div class="key" data-key="ArrowLeft">←</div>
                        <div class="key" data-key="ArrowDown">↓</div>
                        <div class="key" data-key="ArrowRight">→</div>
                    </div>
                </div>

                <!-- Navigation Cluster (Right) -->
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div class="keyboard-row" style="justify-content: flex-start; margin-bottom: 0;">
                        <div class="key key-nav" data-key="Insert">Ins</div>
                        <div class="key key-nav" data-key="Home">Home</div>
                        <div class="key key-nav" data-key="PageUp">PgUp</div>
                    </div>
                    <div class="keyboard-row" style="justify-content: flex-start; margin-bottom: 0;">
                        <div class="key key-nav" data-key="Delete">Del</div>
                        <div class="key key-nav" data-key="End">End</div>
                        <div class="key key-nav" data-key="PageDown">PgDn</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="startKeyboardBtn" class="button">Start Keyboard Test</button>
            <button id="stopKeyboardBtn" class="button" style="display: none;">Stop Test</button>
        </div>

        <div id="keyboardStatus"></div>
    </div>

    <script>
        const video = document.getElementById('video');
        const message = document.getElementById('message');
        const status = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        let stream = null;

        function showStatus(text, type) {
            status.innerHTML = text;
            status.className = 'status ' + type;
        }

        function showMessage(text) {
            message.style.display = 'block';
            message.innerHTML = text;
            video.style.display = 'none';
        }

        function showVideo() {
            message.style.display = 'none';
            video.style.display = 'block';
        }

        async function startWebcam() {
            try {
                showStatus('Requesting webcam access...', 'info');
                startBtn.disabled = true;

                // Request video stream with preferred settings
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: false
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);

                // Verify we have video tracks
                const videoTracks = stream.getVideoTracks();
                if (videoTracks.length === 0) {
                    throw new Error('No video tracks in stream');
                }

                // Set the stream to the video element
                video.srcObject = stream;

                showStatus('Starting video stream...', 'info');
                showVideo();

                // Wait for video to actually start playing
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Video failed to start playing within 10 seconds'));
                    }, 10000);

                    video.addEventListener('playing', function onPlaying() {
                        clearTimeout(timeout);
                        video.removeEventListener('playing', onPlaying);

                        // Verify video has dimensions
                        if (video.videoWidth === 0 || video.videoHeight === 0) {
                            reject(new Error('Video stream has no dimensions'));
                        } else {
                            resolve();
                        }
                    }, { once: true });

                    video.addEventListener('error', function onError() {
                        clearTimeout(timeout);
                        video.removeEventListener('error', onError);
                        reject(new Error('Video element error'));
                    }, { once: true });
                });

                showStatus('✓ Webcam is working! Your camera is functioning correctly. If you cannot see an image, check whether there is a camera cover.', 'success');

                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';

            } catch (error) {
                console.error('Error accessing webcam:', error);

                let errorMessage = 'Unable to access webcam. ';

                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'Camera permission was denied. Please allow camera access in your browser settings.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'No webcam found. Please ensure your camera is connected.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += 'Camera is already in use by another application.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += 'Camera does not meet the required constraints.';
                } else if (error.name === 'SecurityError') {
                    errorMessage += 'Camera access is blocked for security reasons. Make sure you are using HTTPS or localhost.';
                } else {
                    errorMessage += error.message || 'Unknown error occurred.';
                }

                showMessage(errorMessage);
                showStatus('✗ Webcam test failed', 'error');
                startBtn.disabled = false;

                // Clean up stream if it was created
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }
        }

        function stopWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
            }

            showMessage('Webcam stopped. Click the button below to test again.');
            status.innerHTML = '';
            status.className = 'status';

            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            startBtn.disabled = false;
        }

        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showMessage('Sorry, your browser does not support webcam access. Please use a modern browser like Chrome, Firefox, Safari, or Edge.');
            showStatus('✗ Browser not supported', 'error');
            startBtn.disabled = true;
        }

        // Event listeners
        startBtn.addEventListener('click', startWebcam);
        stopBtn.addEventListener('click', stopWebcam);

        // Clean up when page is closed
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // ===== MICROPHONE TEST CODE =====
        const audioCanvas = document.getElementById('audioCanvas');
        const audioMessage = document.getElementById('audioMessage');
        const audioStatus = document.getElementById('audioStatus');
        const startAudioBtn = document.getElementById('startAudioBtn');
        const stopAudioBtn = document.getElementById('stopAudioBtn');
        const playbackBtn = document.getElementById('playbackBtn');
        const timerDisplay = document.getElementById('timer');

        let audioStream = null;
        let audioContext = null;
        let analyser = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordedBlob = null;
        let animationId = null;
        let recordingTimer = null;
        let recordingStartTime = null;
        let playbackAudioContext = null;
        let playbackSource = null;

        function showAudioStatus(text, type) {
            audioStatus.innerHTML = text;
            audioStatus.className = 'status ' + type;
        }

        function showAudioMessage(text) {
            audioMessage.style.display = 'block';
            audioMessage.innerHTML = text;
            audioCanvas.style.display = 'none';
            timerDisplay.style.display = 'none';
        }

        function showAudioCanvas() {
            audioMessage.style.display = 'none';
            audioCanvas.style.display = 'block';
            timerDisplay.style.display = 'block';
        }

        function updateTimer(secondsRemaining) {
            timerDisplay.textContent = `Recording: ${secondsRemaining}s remaining`;
        }

        function visualizeAudio() {
            const canvas = audioCanvas;
            const canvasContext = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                animationId = requestAnimationFrame(draw);

                analyser.getByteFrequencyData(dataArray);

                // Clear canvas
                canvasContext.fillStyle = '#f5f5f5';
                canvasContext.fillRect(0, 0, width, height);

                // Draw frequency bars
                const barCount = 64;
                const barWidth = width / barCount;

                for (let i = 0; i < barCount; i++) {
                    const dataIndex = Math.floor(i * bufferLength / barCount);
                    // Apply 2x scaling to make bars visible but not too tall
                    let barHeight = (dataArray[dataIndex] / 255) * height * 2;
                    // Cap at canvas height to prevent overflow
                    barHeight = Math.min(barHeight, height);

                    // Gradient color based on intensity
                    const intensity = dataArray[dataIndex] / 255;
                    const hue = 250 - (intensity * 50); // Blue to purple gradient
                    canvasContext.fillStyle = `hsl(${hue}, 70%, 60%)`;

                    const x = i * barWidth;
                    const y = height - barHeight;

                    canvasContext.fillRect(x, y, barWidth - 2, barHeight);
                }
            }

            draw();
        }

        async function startMicrophoneTest() {
            try {
                showAudioStatus('Requesting microphone access...', 'info');
                startAudioBtn.disabled = true;
                recordedChunks = [];
                recordedBlob = null;

                // Request audio stream
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                // Verify we have audio tracks
                const audioTracks = audioStream.getAudioTracks();
                if (audioTracks.length === 0) {
                    throw new Error('No audio tracks in stream');
                }

                // Set up Web Audio API for visualization and recording
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;

                // Add gain node to boost audio signal significantly for recording
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 8.0; // 8x boost for much louder recording

                const source = audioContext.createMediaStreamSource(audioStream);
                source.connect(gainNode);
                gainNode.connect(analyser);

                // Create a destination to route the gained audio back to a MediaStream for recording
                const destination = audioContext.createMediaStreamDestination();
                gainNode.connect(destination);

                // Set up MediaRecorder with the boosted audio stream
                mediaRecorder = new MediaRecorder(destination.stream);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                    playbackBtn.style.display = 'inline-block';
                    showAudioStatus('✓ Recording complete! Click "Play Recording" to hear what was recorded.', 'success');
                };

                // Start recording
                mediaRecorder.start();
                recordingStartTime = Date.now();

                showAudioCanvas();
                visualizeAudio();

                // 15 second countdown timer
                let secondsRemaining = 15;
                updateTimer(secondsRemaining);

                recordingTimer = setInterval(() => {
                    secondsRemaining--;
                    if (secondsRemaining > 0) {
                        updateTimer(secondsRemaining);
                    } else {
                        stopMicrophoneTest();
                    }
                }, 1000);

                showAudioStatus('Recording in progress... Speak or make sounds to test your microphone.', 'info');
                startAudioBtn.style.display = 'none';
                stopAudioBtn.style.display = 'inline-block';

            } catch (error) {
                console.error('Error accessing microphone:', error);

                let errorMessage = 'Unable to access microphone. ';

                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'Microphone permission was denied. Please allow microphone access in your browser settings.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'No microphone found. Please ensure your microphone is connected.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += 'Microphone is already in use by another application.';
                } else {
                    errorMessage += error.message || 'Unknown error occurred.';
                }

                showAudioMessage(errorMessage);
                showAudioStatus('✗ Microphone test failed', 'error');
                startAudioBtn.disabled = false;

                cleanupAudio();
            }
        }

        function stopMicrophoneTest() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }

            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            cleanupAudio();

            showAudioMessage('Recording stopped. Click "Play Recording" to hear what was recorded.');
            stopAudioBtn.style.display = 'none';
            startAudioBtn.style.display = 'inline-block';
            startAudioBtn.disabled = false;
        }

        function cleanupAudio() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            analyser = null;
        }

        async function playRecording() {
            if (!recordedBlob) {
                showAudioStatus('No recording available to play.', 'error');
                return;
            }

            // Clean up previous playback if any
            if (playbackAudioContext) {
                playbackAudioContext.close();
            }

            try {
                showAudioStatus('Playing recording...', 'info');
                playbackBtn.disabled = true;

                // Convert blob to array buffer
                const arrayBuffer = await recordedBlob.arrayBuffer();

                // Create new audio context for playback
                playbackAudioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Decode audio data
                const audioBuffer = await playbackAudioContext.decodeAudioData(arrayBuffer);

                // Create source and gain node for boosted playback
                playbackSource = playbackAudioContext.createBufferSource();
                playbackSource.buffer = audioBuffer;

                const playbackGain = playbackAudioContext.createGain();
                playbackGain.gain.value = 2.0; // Additional 2x boost for playback

                playbackSource.connect(playbackGain);
                playbackGain.connect(playbackAudioContext.destination);

                playbackSource.onended = () => {
                    showAudioStatus('Playback complete.', 'info');
                    playbackBtn.disabled = false;
                };

                playbackSource.start(0);

            } catch (error) {
                console.error('Error playing recording:', error);
                showAudioStatus('Error playing recording.', 'error');
                playbackBtn.disabled = false;
            }
        }

        // Check if getUserMedia is supported for audio
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showAudioMessage('Sorry, your browser does not support microphone access. Please use a modern browser like Chrome, Firefox, Safari, or Edge.');
            showAudioStatus('✗ Browser not supported', 'error');
            startAudioBtn.disabled = true;
        }

        // Event listeners for audio
        startAudioBtn.addEventListener('click', startMicrophoneTest);
        stopAudioBtn.addEventListener('click', stopMicrophoneTest);
        playbackBtn.addEventListener('click', playRecording);

        // Clean up audio when page is closed
        window.addEventListener('beforeunload', () => {
            cleanupAudio();
            if (playbackAudioContext) {
                playbackAudioContext.close();
            }
        });

        // ===== SPEAKER TEST CODE =====
        const speakerMessage = document.getElementById('speakerMessage');
        const speakerIndicator = document.getElementById('speakerIndicator');
        const speakerPhase = document.getElementById('speakerPhase');
        const speakerStatus = document.getElementById('speakerStatus');
        const startSpeakerBtn = document.getElementById('startSpeakerBtn');
        const stopSpeakerBtn = document.getElementById('stopSpeakerBtn');

        let speakerAudioContext = null;
        let speakerOscillator = null;
        let speakerGainNode = null;
        let speakerPanner = null;
        let speakerTestTimer = null;

        function showSpeakerStatus(text, type) {
            speakerStatus.innerHTML = text;
            speakerStatus.className = 'status ' + type;
        }

        function showSpeakerMessage(text) {
            speakerMessage.style.display = 'block';
            speakerMessage.innerHTML = text;
            speakerIndicator.style.display = 'none';
        }

        function showSpeakerIndicator() {
            speakerMessage.style.display = 'none';
            speakerIndicator.style.display = 'block';
        }

        function playNoteSequence(startTime, panValue) {
            // Play a C major arpeggio: C4, E4, G4, C5 and back down
            const notes = [261.63, 329.63, 392.00, 523.25, 392.00, 329.63, 261.63]; // C-E-G-C-G-E-C
            const noteDuration = 0.4; // Each note lasts 0.4 seconds

            let currentTime = startTime;

            notes.forEach((frequency) => {
                const osc = speakerAudioContext.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(frequency, currentTime);

                const noteGain = speakerAudioContext.createGain();
                noteGain.gain.setValueAtTime(0, currentTime);
                noteGain.gain.linearRampToValueAtTime(0.2, currentTime + 0.05); // Attack
                noteGain.gain.setValueAtTime(0.2, currentTime + noteDuration - 0.1);
                noteGain.gain.linearRampToValueAtTime(0, currentTime + noteDuration); // Release

                const notePanner = speakerAudioContext.createStereoPanner();
                notePanner.pan.setValueAtTime(panValue, currentTime);

                osc.connect(noteGain);
                noteGain.connect(notePanner);
                notePanner.connect(speakerAudioContext.destination);

                osc.start(currentTime);
                osc.stop(currentTime + noteDuration);

                currentTime += noteDuration;
            });
        }

        async function startSpeakerTest() {
            try {
                startSpeakerBtn.disabled = true;
                startSpeakerBtn.style.display = 'none';
                stopSpeakerBtn.style.display = 'inline-block';

                // Create audio context
                speakerAudioContext = new (window.AudioContext || window.webkitAudioContext)();

                showSpeakerIndicator();

                const startTime = speakerAudioContext.currentTime;

                // Phase 1: Center (0-3s)
                speakerPhase.textContent = 'Center';
                showSpeakerStatus('Playing notes from center speakers', 'info');
                playNoteSequence(startTime, 0);

                // Phase 2: Left (3-6s)
                speakerTestTimer = setTimeout(() => {
                    speakerPhase.textContent = 'Left';
                    showSpeakerStatus('Playing notes from left speaker', 'info');
                    playNoteSequence(speakerAudioContext.currentTime, -1);

                    // Phase 3: Right (6-9s)
                    speakerTestTimer = setTimeout(() => {
                        speakerPhase.textContent = 'Right';
                        showSpeakerStatus('Playing notes from right speaker', 'info');
                        playNoteSequence(speakerAudioContext.currentTime, 1);

                        // Phase 4: Center again (9-12s)
                        speakerTestTimer = setTimeout(() => {
                            speakerPhase.textContent = 'Center';
                            showSpeakerStatus('Playing notes from center speakers', 'info');
                            playNoteSequence(speakerAudioContext.currentTime, 0);

                            // End test (12s)
                            speakerTestTimer = setTimeout(() => {
                                stopSpeakerTest();
                                showSpeakerStatus('✓ Speaker test complete!', 'success');
                            }, 3000);
                        }, 3000);
                    }, 3000);
                }, 3000);

            } catch (error) {
                console.error('Error starting speaker test:', error);
                showSpeakerMessage('Error starting speaker test. Please try again.');
                showSpeakerStatus('✗ Speaker test failed', 'error');
                cleanupSpeaker();
                startSpeakerBtn.disabled = false;
                startSpeakerBtn.style.display = 'inline-block';
                stopSpeakerBtn.style.display = 'none';
            }
        }

        function stopSpeakerTest() {
            if (speakerTestTimer) {
                clearTimeout(speakerTestTimer);
                speakerTestTimer = null;
            }

            cleanupSpeaker();

            showSpeakerMessage('Speaker test stopped. Click the button below to test again.');

            startSpeakerBtn.disabled = false;
            startSpeakerBtn.style.display = 'inline-block';
            stopSpeakerBtn.style.display = 'none';
        }

        function cleanupSpeaker() {
            if (speakerOscillator) {
                try {
                    speakerOscillator.stop();
                } catch (e) {
                    // Oscillator already stopped
                }
                speakerOscillator = null;
            }

            if (speakerAudioContext) {
                speakerAudioContext.close();
                speakerAudioContext = null;
            }

            speakerGainNode = null;
            speakerPanner = null;
        }

        // Event listeners for speaker test
        startSpeakerBtn.addEventListener('click', startSpeakerTest);
        stopSpeakerBtn.addEventListener('click', stopSpeakerTest);

        // ===== TRACKPAD BUTTON TEST CODE =====
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');
        const trackpadStatus = document.getElementById('trackpadStatus');

        let leftClickCount = 0;
        let rightClickCount = 0;

        function showTrackpadStatus(text, type) {
            trackpadStatus.innerHTML = text;
            trackpadStatus.className = 'status ' + type;
        }

        // Prevent context menu on right click
        document.addEventListener('contextmenu', (event) => {
            event.preventDefault();
        });

        // Handle mouse down events
        document.addEventListener('mousedown', (event) => {
            if (event.button === 0) {
                // Left button clicked
                leftButton.classList.add('active');
                leftClickCount++;
                showTrackpadStatus(`Left button clicked ${leftClickCount} time${leftClickCount === 1 ? '' : 's'}`, 'success');
            } else if (event.button === 2) {
                // Right button clicked
                rightButton.classList.add('active');
                rightClickCount++;
                showTrackpadStatus(`Right button clicked ${rightClickCount} time${rightClickCount === 1 ? '' : 's'}`, 'success');
            }
        });

        // Handle mouse up events to remove highlight
        document.addEventListener('mouseup', (event) => {
            if (event.button === 0) {
                leftButton.classList.remove('active');
            } else if (event.button === 2) {
                rightButton.classList.remove('active');
            }
        });

        // Initial status message
        showTrackpadStatus('Click the left or right mouse button to test your trackpad buttons', 'info');

        // ===== KEYBOARD TEST CODE =====
        const keyboardMessage = document.getElementById('keyboardMessage');
        const keyboardContainer = document.getElementById('keyboardContainer');
        const keyboardStatus = document.getElementById('keyboardStatus');
        const startKeyboardBtn = document.getElementById('startKeyboardBtn');
        const stopKeyboardBtn = document.getElementById('stopKeyboardBtn');

        let keyboardTestActive = false;
        let keyboardAudioContext = null;
        let pressedKeys = new Set();

        function showKeyboardStatus(text, type) {
            keyboardStatus.innerHTML = text;
            keyboardStatus.className = 'status ' + type;
        }

        function playKeyClick() {
            if (!keyboardAudioContext) return;

            // Create a short click sound
            const oscillator = keyboardAudioContext.createOscillator();
            const gainNode = keyboardAudioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, keyboardAudioContext.currentTime);

            // Very short envelope for a click sound
            gainNode.gain.setValueAtTime(0.1, keyboardAudioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, keyboardAudioContext.currentTime + 0.02);

            oscillator.connect(gainNode);
            gainNode.connect(keyboardAudioContext.destination);

            oscillator.start(keyboardAudioContext.currentTime);
            oscillator.stop(keyboardAudioContext.currentTime + 0.02);
        }

        function getKeyElement(key) {
            // Normalize key for lookup
            const normalizedKey = key.toLowerCase();

            try {
                // Try exact match first
                let keyElement = document.querySelector(`.key[data-key="${key}"]`);

                // Try lowercase match for letters
                if (!keyElement) {
                    keyElement = document.querySelector(`.key[data-key="${normalizedKey}"]`);
                }

                return keyElement;
            } catch (e) {
                // CSS selector might fail for special characters like quotes
                return null;
            }
        }

        function codeToBaseKey(code) {
            // Convert event.code to base key character
            if (code.startsWith('Digit')) {
                return code.replace('Digit', '');
            }
            if (code.startsWith('Key')) {
                return code.replace('Key', '').toLowerCase();
            }
            // Map common codes to base characters
            const codeMap = {
                'Minus': '-',
                'Equal': '=',
                'BracketLeft': '[',
                'BracketRight': ']',
                'Backslash': '\\',
                'IntlBackslash': '\\',
                'Semicolon': ';',
                'Quote': "'",
                'Backquote': '`',
                'Comma': ',',
                'Period': '.',
                'Slash': '/'
            };
            return codeMap[code] || null;
        }

        function handleKeyDown(event) {
            if (!keyboardTestActive) return;

            // Prevent ALL default actions during keyboard test to avoid browser/OS shortcuts
            event.preventDefault();

            const key = event.key;
            const code = event.code;

            // Don't re-trigger for held keys
            if (pressedKeys.has(code)) return;
            pressedKeys.add(code);

            // Find the key element - try multiple matching strategies
            let keyElement = getKeyElement(key);

            // Try by code if key didn't work
            if (!keyElement) {
                keyElement = document.querySelector(`.key[data-key="${code}"]`);
            }

            // Try to convert code to base key (e.g., Digit2 -> 2, KeyA -> a)
            if (!keyElement) {
                const baseKey = codeToBaseKey(code);
                if (baseKey) {
                    keyElement = document.querySelector(`.key[data-key="${baseKey}"]`);
                }
            }

            // Special handling for backslash which might report as different codes
            if (!keyElement && (key === '\\' || code === 'Backslash' || code === 'IntlBackslash')) {
                keyElement = document.querySelector(`.key[data-key="\\\\"]`);
            }

            if (keyElement) {
                // Add active state
                keyElement.classList.add('active');

                // Mark as pressed (permanently) - only set green border once
                if (!keyElement.classList.contains('pressed')) {
                    keyElement.classList.add('pressed');
                }

                // Play click sound every time
                playKeyClick();
            }
        }

        function handleKeyUp(event) {
            if (!keyboardTestActive) return;

            const key = event.key;
            const code = event.code;

            pressedKeys.delete(code);

            // Find the key element - use same matching logic as keydown
            let keyElement = getKeyElement(key);

            if (!keyElement) {
                keyElement = document.querySelector(`.key[data-key="${code}"]`);
            }

            // Try to convert code to base key (e.g., Digit2 -> 2, KeyA -> a)
            if (!keyElement) {
                const baseKey = codeToBaseKey(code);
                if (baseKey) {
                    keyElement = document.querySelector(`.key[data-key="${baseKey}"]`);
                }
            }

            // Special handling for backslash
            if (!keyElement && (key === '\\' || code === 'Backslash' || code === 'IntlBackslash')) {
                keyElement = document.querySelector(`.key[data-key="\\\\"]`);
            }

            if (keyElement) {
                // Remove active state (but keep pressed state)
                keyElement.classList.remove('active');
            }
        }

        function clearActiveKeys() {
            // Clear all active highlights (but keep the green pressed borders)
            document.querySelectorAll('.key.active').forEach(key => {
                key.classList.remove('active');
            });
            pressedKeys.clear();
        }

        function handleWindowBlur() {
            if (keyboardTestActive) {
                clearActiveKeys();
            }
        }

        function handleVisibilityChange() {
            if (keyboardTestActive && document.hidden) {
                clearActiveKeys();
            }
        }

        function startKeyboardTest() {
            keyboardTestActive = true;
            keyboardAudioContext = new (window.AudioContext || window.webkitAudioContext)();

            keyboardMessage.style.display = 'none';
            keyboardContainer.style.display = 'block';

            startKeyboardBtn.style.display = 'none';
            stopKeyboardBtn.style.display = 'inline-block';

            showKeyboardStatus('Press keys on your keyboard. Pressed keys will be highlighted with a green border.', 'info');

            // Add event listeners
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            window.addEventListener('blur', handleWindowBlur);
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        function stopKeyboardTest() {
            keyboardTestActive = false;

            // Remove event listeners
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
            window.removeEventListener('blur', handleWindowBlur);
            document.removeEventListener('visibilitychange', handleVisibilityChange);

            if (keyboardAudioContext) {
                keyboardAudioContext.close();
                keyboardAudioContext = null;
            }

            // Count pressed keys
            const pressedCount = document.querySelectorAll('.key.pressed').length;
            const totalKeys = document.querySelectorAll('.key').length;

            keyboardMessage.style.display = 'block';
            keyboardMessage.innerHTML = `Test stopped. You tested ${pressedCount} out of ${totalKeys} keys.`;
            keyboardContainer.style.display = 'none';

            startKeyboardBtn.style.display = 'inline-block';
            stopKeyboardBtn.style.display = 'none';

            // Reset all keys
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('active', 'pressed');
            });

            pressedKeys.clear();
        }

        // Event listeners for keyboard test
        startKeyboardBtn.addEventListener('click', startKeyboardTest);
        stopKeyboardBtn.addEventListener('click', stopKeyboardTest);

        // Clean up all tests when page is closed
        window.addEventListener('beforeunload', () => {
            cleanupSpeaker();
            if (keyboardAudioContext) {
                keyboardAudioContext.close();
            }
        });
    </script>
</body>
</html>
